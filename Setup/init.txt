# Setup required before starting the project.

# Hardware requirements:
# Host: cpu, mem, disk, os.
# Target: cpu, mem, disk, os.

# Host configurations:
# Create host user
sudo adduser host
sudo usermod -aG sudo host
sudo visudo
# add at the bottom: host ALL=(ALL) NOPASSWD:ALL
# save and close.
mkdir .ssh
chmod 700 ~/.ssh
touch ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chown -R host:host ~/.ssh
# Put target id_rsa.pub key in host authorized_keys

# Target configurations:
# Create target user
sudo adduser target
sudo usermod -aG sudo target
sudo visudo
# add at the bottom: target ALL=(ALL) NOPASSWD:ALL
# save and close.
# Create SSH keys:
ssh-keygen -t rsa

#Installation (Host & Target):

# 1- CRIU:
sudo apt-get update
sudo apt-get install -y software-properties-common
sudo add-apt-repository ppa:criu/ppa
sudo apt-get update
sudo apt-get install -y criu
sudo criu --version
sudo criu check

# 2- zip/unzip packages:
sudo apt install zip unzip -y

# 3- iperf package:
sudo apt update && sudo apt install iperf -y

# 4- Docker:
for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do sudo apt-get remove $pkg; done

sudo apt-get update
sudo apt-get install -y ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl enable docker


# 4.1- Enable experimental tools for docker
sudo vi /etc/docker/daemon.json
# add: 
{
  "experimental": true
}

# 4.2- Add sudo to docker (host and target):
sudo groupadd docker
sudo usermod -aG docker $USER
newgrp docker
docker ps

# 5- Podman: 
...

# 6- For containers with TCP sessions:
# Enable tcp-established
sudo mkdir /etc/criu/
sudo touch /etc/criu/runc.conf
sudo chmod 644 /etc/criu/runc.conf
sudo vi /etc/criu/runc.conf
# Add: tcp-established
# Save and quit
sudo systemctl restart docker
# Restart Podman
...
